#!/usr/bin/env bash
# External command to show what casks have been changed in homebrew-cask
# By @alebcay https://github.com/caskroom/homebrew-cask/issues/5839#issuecomment-66958632
# Modified by @Amorymeltzer
# Should really rubify this or something
## More convenient columnization
## Colors show up via sudo, deescalation

checkNew() {
    while read line; do
	if [[ $line == A* ]]
	then
	    word=$(echo $line | cut -d \  -f 2)
	    word=${word##*/}
	    word=${word%.*}
	    echo $word
	fi
    done < /tmp/git-difftree-log.txt
}

checkDeleted() {
    while read line; do
	if [[ $line == D* ]]
	then
	    word=$(echo $line | cut -d \  -f 2)
	    word=${word##*/}
	    word=${word%.*}
	    echo $word
	fi
    done < /tmp/git-difftree-log.txt
}

checkModified() {
    while read line; do
	if [[ $line == M* ]]
	then
	    word=$(echo $line | cut -d \  -f 2)
	    word=${word##*/}
	    word=${word%.*}
	    echo $word
	fi
    done < /tmp/git-difftree-log.txt
}

checkRenamed() {
    while read line; do
	if [[ $line == R* ]]
	then
	    word=$(echo $line | cut -d \  -f 2)
	    word=${word##*/}
	    word=${word%.*}
	    echo -n $word
	    echo -ne " â†’ "
	    newword=$(echo $line | cut -d \  -f 3)
	    newword=${newword##*/}
	    newword=${newword%.*}
	    echo $newword
	    echo "|"
	fi
    done < /tmp/git-difftree-log.txt
}

cd $(brew --prefix)/Library/Taps/caskroom/homebrew-cask
OLDREV=$(git rev-parse -q --short --verify HEAD)
brew update
echo
NEWREV=$(git rev-parse -q --short --verify HEAD)
if [ "$OLDREV" = "$NEWREV" ]
then
    echo "Homebrew-cask already up to date."
    exit 0
fi
echo "Updated Homebrew-Cask from $OLDREV to $NEWREV."
git diff-tree --name-status -r --diff-filter=AMDR -M10% $OLDREV $NEWREV Casks/ > /tmp/git-difftree-log.txt

NEWRESULT=$(checkNew)
if [[ -n $NEWRESULT ]]; then
    echo -e "${Color_Blue_Bold}==> ${Color_zOff}${Color_zBold}New Casks${Color_zOff}"
    printf "%-30s %-30s %-30s %-30s %-30s %-30s\n" $(echo $NEWRESULT)
fi

DELRESULT=$(checkDeleted)
if [[ -n $DELRESULT ]]; then
    echo -e "${Color_Blue_Bold}==> ${Color_zOff}${Color_zBold}Deleted Casks${Color_zOff}"
    printf "%-30s %-30s %-30s %-30s %-30s %-30s\n" $(echo $DELRESULT)
fi

MODRESULT=$(checkModified)
if [[ -n $MODRESULT ]]; then
    echo -e "${Color_Blue_Bold}==> ${Color_zOff}${Color_zBold}Updated Casks${Color_zOff}"
    printf "%-30s %-30s %-30s %-30s %-30s %-30s\n" $(echo $MODRESULT)
fi

RNMRESULT=$(checkRenamed)
if [[ -n $RNMRESULT ]]; then
    echo -e "${Color_Blue_Bold}==> ${Color_zOff}${Color_zBold}Renamed Casks${Color_zOff}"
    echo $RNMRESULT | perl -pe 's/\s*\|\s*/\n/g'
fi
rm /tmp/git-difftree-log.txt
