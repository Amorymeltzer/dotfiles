#!/usr/bin/env bash
# update by Amory Meltzer
# UPDATE ALL THE THINGS!!!


function help {
    cat <<END_HELP
Usage: $1 [-b INTEGER] [-c] [-C] [-h]

  -c			check for cpan updates but don't upgrade
  -C			skip all cpan actions
  -h			this help

END_HELP
}

cpan_flag="0"
# Parse commandline options
while getopts "cCh" opt; do
    case $opt in
	c ) cpan_flag="1";;
	C ) cpan_flag="2";;
	h ) help $0
	    exit 0;;
	\?) printf "Invalid option: -"$opt", try $0 -h\n" >&2
            exit 1;;
	: ) printf "Option -"$opt" requires an argument, try $0 -h\n" >&2
            exit 1;;
    esac
done

# Ask for sudo early
sudo -v

# Need to find a way to do things it suggests, like port select and so on
# ;;;;;; ##### FIXME TODO
echo -e "${Color_Cyan}Updating ${Color_Red_Intense}MacPorts${Color_zOff}..."
pall
echo -e "${Color_White}Cleaning ${Color_Red_Intense}MacPorts${Color_zOff}..."
port -v uninstall inactive;
echo -e "${Color_Green}Logging leaves${Color_zOff}..."
port echo leaves >> ~/port_leaves_log.txt;
port -v uninstall leaves;
port clean -v --all installed

echo -e "${Color_Cyan}Upgrading ${Color_Red_Intense}pip python packages${Color_zOff}..."
pipupgrade;

echo -e "${Color_Cyan}Upgrading ${Color_Red_Intense}gems${Color_zOff}..."
gem update --system
gem update
echo -e "${Color_White}Cleaning ${Color_Red_Intense}gems${Color_zOff}..."
gem cleanup;

if [ $cpan_flag < 2 ]; then
    echo -e "${Color_Cyan}Checking ${Color_Red_Intense}CPAN modules${Color_zOff}..."
    cpan-outdated --verbose
    if [ $cpan_flag < 1 ]; then
	echo -e "${Color_Cyan}Upgrading ${Color_Red_Intense}CPAN modules${Color_zOff}..."
	cpan-outdated | xargs cpan -i
    fi
    echo -e "${Color_White}Cleaning ${Color_Red_Intense}CPAN directories${Color_zOff}..."
    cpanclean;
fi

sudo -k

# Should probably make this verbose or something
echo -e "${Color_Cyan}Updating ${Color_Red_Intense}Homebrew${Color_zOff}..."
brew update
brew outdated
brew upgrade

# Not perfect, but uses the external brewcask-doutdated.rb command to grab
# a list of outdated casks, then --force reinstalls them
echo -e "${Color_Cyan}Updating ${Color_Red_Intense}casks${Color_zOff}..."
brew cask doutdated
brew cask doutdated | xargs brew cask install --force

echo -e "${Color_White}Cleaning ${Color_Red_Intense}Homebrew${Color_zOff}..."
brew cleanup -ns
brew cleanup -s
echo -e "${Color_White}Cleaning ${Color_Red_Intense}casks${Color_zOff}..."
brew cask cleanup --verbose
