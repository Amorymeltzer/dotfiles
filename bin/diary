#!/usr/bin/env bash
# diary by Amory Meltzer
# Basic script to handle a basic diary

function help {
    cat <<END_HELP
Usage: $(basename $0) [-h] [new|notes|last|rand|log|remove|rm|delete|YYY-MM-DD|stats]

  Without any parameters, diary will open today's entry for you; if it hasn't
  been started yet, it will create the file with, and populate it with the
  content of a "notes" file.  If you're not in the directory defined by the
  $DIARY_DIR environment variable, it will exit.

  Other options:

  new			Create a new file, without opening
  notes			Edit the notes file
  last			Display the last diary entry
  rand			Display a random diary entry
  log			Commit today's file, only if the directory is managed by git
  remove, rm, delete	Remove today's entry, if present
  YYYY-MM-DD		Display the diary entry from a specific day
  stats			Display some basic statistics (currently just number of entries)
END_HELP
}

while getopts 'h' opt; do
    case $opt in
	h) help $0
	   exit 0;;
    esac
done

if [[ -z "$DIARY_DIR" ]]; then
    echo "No diary directory configured, please set \$DIARY_DIR"
    exit 1
elif [[ $(pwd) != "$DIARY_DIR" ]]; then
    echo "Not in $DIARY_DIR, exiting"
    exit 1
fi


today=$(date +"%Y-%m-%d").md

function newDay {
    if [[ ! -f $today ]]; then
	title=$(date +"%A, %B %d, %Y")
	printf "## $title\n\n" > $today
	notes=$(cat notes)
	if [[ -n $notes ]]; then
	    printf "### Thoughts ###\n" >> $today
	    echo "$notes" >> $today
	fi
	printf "### Morning\n\n\n### Afternoon\n\n\n### Evening\n" >> $today
    fi
}

if [[ ! $1 ]]; then
    newDay
    $VISUAL "$today"
else
    # Show a specific date
    if [[ $1 =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
	if [[ ! -f "$1.md" ]]; then
	    echo "No entry for $1"
	    exit 1
	else
	    cat "$1.md"
	fi
    else
	case "$1" in
	    "new") newDay;;
	    "notes") $VISUAL notes;;
	    "last")
		# Display latest entry, not including today's
		cat $(ls -1tr *.md | tail -n 2 | grep -v $today | tail -n 1);;
	    "rand")
		# Display a random entry
		cat $(ls -1 | shuf | head -n 1);;
	    "remove"|"rm"|"delete")
		[ -f "$today" ] && rm "$today" || echo "No entry for today found";;
	    "log")
		# Commit entry, if git
		[[ ! $(git rev-parse --is-inside-work-tree 2>/dev/null) ]] && exit 1
		# Reset the index, just in case
		git reset HEAD --

		# Ensure there's just one file, and that it's today
		status=$(git status --porcelain)
		if [[ $(wc -l <<< "$status") -ne 1 ]]; then
		    echo "Too many files present, exiting"
		    exit 1
		elif [[ "$(cut -c 4- <<< "$status")" != "$today" ]]; then
		    echo "File isn't for today, exiting"
		    exit 1
		fi

		git add $today
		# Commit if untracked, amend if already present
		if [[ "$(cut -c 1-2 <<< "$status")" == "??" ]]; then
		    git commit -m $today
		elif [[ "$(cut -c 1-2 <<< "$status")" == " M" ]]; then
		    git commit --amend --no-edit
		else
		    echo "$status"
		    echo "Unknown situation, exiting"
		    exit 1
		fi;;
	    "stats")
		# Basic stats, should expand this (days done (since date?), etc.)
		# This should be find but whatever
		count=$(ls -1 | grep -E "\d{4}-\d{2}-\d{2}\.md" | wc -l | tr -d ' ')
		echo "There are $count entries!";;
	    *) echo "Unknown option"
	       exit 1;;
	esac
    fi
fi
