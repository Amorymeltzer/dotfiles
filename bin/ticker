#!/usr/bin/env python
# Grab current price of stock or index
# Use python to colorize, columnize, etc.
# Heavily based off bitbar gfinance plugin:
# https://github.com/matryer/bitbar-plugins/blob/master/Finance/gfinance.5m.py
# TODO: Use up/down arrows instead of up/down?

import sys

if len(sys.argv) <= 1:
    sys.exit(1)

# Stocks can be provided as symbol (AAPL) or exchange:symbol (NASDAQ:AAPL)
stocks=sys.argv[1:]

# Nothing fancy
class colors:
    GREEN = '\033[32m'
    RED = '\033[31m'
    ENDC = '\033[0m'

import urllib2
import json
import re
for i in stocks:
    url = "http://finance.google.com/finance/info?client=ig&q=" + i

    try:
        u = urllib2.urlopen(url)
    except Exception:
        print "Ticker lookup of %s failed" % i
        continue

    quote = u.read()
    obj = json.loads(quote[4:-1])

    for ticker in obj:
        perc = "(" + ticker["cp"] + "%)"
        if float(ticker["c"]) < 0:
            color = colors.RED
            perc = re.sub('-', '', perc)
        else:
            color = colors.GREEN

        name = re.sub('^\.', '', ticker["t"])
        print color + "\t".join([name, ticker["l"], ticker["c"], perc]) + colors.ENDC
